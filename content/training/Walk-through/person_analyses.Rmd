---
date: "2019-08-21T10:38:36+02:00"
title: Person analyses
weight: 12
---



```{r setup, include=FALSE, results='hide', message=FALSE, warning=FALSE}
# hide all code chunks in the output, but show errors
knitr::opts_chunk$set(echo = TRUE,       # hide all code chunks in output
                      error = TRUE,       # show errors if they appear, but don't stop
                      fig.width = 6*1.25, # Figure width
                      fig.height = 6      # Figure height
                     )
# set default NA to - in output, define figure width/height
options(knitr.kable.NA = "-")

# Installing required packages for this template
required_packages <- c("knitr",       # create output docs
                       "dplyr",       # clean/shape data
                       "forcats",     # clean/shape data
                       "stringr",     # clean text
                       "rio",         # read in data
                       "ggplot2",     # create plots and charts
                       "sitrep",      # MSF field epi functions
                       "linelist",    # Functions for cleaning/standardising data
                       "incidence",   # create epicurves
                       "aweek",       # define epi weeks
                       "epitools",    # 2x2 tables and other epi goodness
                       "epitrix",     # epi helpers and tricks
                       "sf",          # encode spatial vector data
                       "ggspatial")   # plot maps

for (pkg in required_packages) {
  # install packages if not already present
  if (!pkg %in% rownames(installed.packages())) {
    install.packages(pkg)
  }
  
  # load packages to this current session 
  library(pkg, character.only = TRUE)
}


# set default text size to 16 for plots
# give classic black/white axes for plots
ggplot2::theme_set(theme_classic(base_size = 18))

# Set the day that defines the beginning of your epiweek.
# you can start the week on any day of the week
# (the ISO standard is to start on Monday) 
aweek::set_week_start("Monday")



date2week("2017-04-20")      #Sys.Date() uses the current date from your computer


reporting_week <- readRDS("data/reporting_week.rds") # Set the reporting week

# Read in the R object linelist_cleaned that is defined and saved 
# in the AJS_Walkthrough_Cleaning script
linelist_cleaned <- readRDS("data/linelist_cleaned.rds")

population_data_region <- readRDS("data/population_data.rds")

SYMPTOMS <- readRDS("data/SYMPTOMS.rds")
LABS <- readRDS("data/LABS.rds")
first_week <- readRDS("data/first_week.rds")
obs_start <- readRDS("data/obs_start.rds")
obs_end <- readRDS("data/obs_end.rds")

```




## Person 

TODO [general description of person section]

### Demographic Tables:

The first demographic table presents patients by their age group (the table's rows) and their relationship with the case definition (the table's columns). Arguments row_total and col_total are set to TRUE, resulting in totals shown for rows and columns.  

* The select() command removed an unnecessary column "variable" generated by tab_linelist().  
* The rename() command renames the column "value" with "Age Group"  
* The rename_redundant() command replaces any column name that has proportion with "%"  
* The augment_redundant() command replaces any column name with n with " cases (n)"  
* The kable() command completes the table with two digits after a decimal

**TODO: There seems to still be issues with the new tab_linelist function. Error says object proportion is unknown. Need to resolve and then remove the # from the rename_redundant line below.** 

```{r describe_by_age_group_and_def}
# use if you have lab results in your data
# get counts and props of age groups by case definition 
# include column and row totals 
tab_linelist(linelist_cleaned, 
             age_group, strata = case_def, 
             col_total = TRUE, row_total = TRUE) %>%
  select(-variable) %>%
  rename("Age group" = value) %>%
  rename_redundant("%" = proportion) %>%
  augment_redundant(" cases (n)" = " n$") %>%
  kable(digits = 2)
```

As demonstrated in the subsequent template code, you can change the argument strata = to refer to any number of variables including sex. You can also choose to include or edit the in-line code that gives a count of the missing cases by sex and age_group. 

To show proportions of the total population, use the following code, with the argument prop_total specified as TRUE. 

```{r total_props_agegroup_sex}
tab_linelist(linelist_cleaned, 
             age_group, strata = sex,
             col_total = TRUE, row_total = TRUE, prop_total = TRUE) %>% 
  select(-variable) %>%
  rename("Age group" = value) %>%
#  rename_redundant("%" = proportion) %>%
  augment_redundant(" cases (n)" = " n$") %>%
  kable(digits = 2)
```


### Age pyramid 
To print an age pyramid in your report, use the code below. A few things to note:  

* The **variable for split_by should have two non-missing value options** (e.g. Male or Female, Oui or Non, etc.)  
* The variable names work with or without quotation marks  
* The dashed lines in the bars are the midpoint of the un-stratified age group   
* You can adjust the position of the legend by replacing legend.position = "bottom" with "top", "left", or "right"  
* Read more by searching plot_age_pyramid in the Help tab of the lower-right RStudio pane  

You can make this a pyramid of months by supplying age_group_mon to the age_group argument.  



```{r age_pyramid, warning=FALSE}
# plot age pyramid 
 
plot_age_pyramid(linelist_cleaned, 
                 age_group = "age_group_mon", 
                 split_by = "sex") + 
  labs(y = "Cases (n)", x = "Age group") + # change axis  labels (nb. x/y flip)
  theme(legend.position = "bottom",     # move legend to bottom
        legend.title = element_blank(), # remove title
        text = element_text(size = 18)  # change text size
       )
```




```{r describe_by_symptoms}
# get counts and proportions for all variables named in SYMPTOMS
tab_linelist(linelist_cleaned, SYMPTOMS, keep = "Yes") %>% 
  select(-value) %>%
  # fix the way symptom names are displayed
  mutate(variable = str_to_sentence(gsub("_", " ", variable))) %>%
  # rename accordingly
  rename_redundant("%" = proportion) %>%
  augment_redundant(" (n)" = " n$") %>%
  kable(digits = 2)
```

```{r describe_by_labs}
# get counts and proportions for all variables named in LABS
multi_descriptive(linelist_cleaned, LABS, .id = "Lab test") %>% 
  # re-order columns (drop total_prop too)
  select("Lab test", Pos_n, Positive_prop, Neg_n, Negative_prop, 
         "Not done_n", "Not done_prop", Total_n) %>% 
  # rename accordingly
  rename("Unknown (n)" = "Not done_n") %>%
  rename_redundant("prop" = "%") %>%
  augment_redundant("_n$" = " (n)") %>%
  kable(digits = 2)

```

## CFR Section

Time to death not applicable. 



The case fatality ratio among inpatients with known outcomes is below.



Case Fatality Ratio - note that this requires there to be a variable patient_facilit_type, the value "Inpatient", and the DIED variable created earlier. 

```{r overall_cfr, warning = FALSE, message = FALSE}
# use arguments from above to produce overal CFR
overall_cfr <- linelist_cleaned %>% 
  filter(patient_facility_type == "Inpatient") %>%
  case_fatality_rate_df(deaths = DIED, mergeCI = TRUE) %>%
  rename("Deaths" = deaths,
         "Cases" = population,
         "CFR (%)" = cfr,
         "95%CI" = ci)

  knitr::kable(overall_cfr, digits = 2)         # print nicely with 2 digits
```



We can also do CFR by sex

```{r cfr_by_sex, warning = FALSE, message = FALSE}
linelist_cleaned %>%
  filter(patient_facility_type == "Inpatient") %>%
  mutate(sex = forcats::fct_explicit_na(sex, "-")) %>%
  case_fatality_rate_df(deaths = DIED, group = sex, mergeCI = TRUE, add_total = TRUE) %>%
  rename("Sex" = sex, 
         "Deaths" = deaths, 
         "Cases" = population, 
         "CFR (%)" = cfr, 
         "95%CI" = ci) %>% 
  knitr::kable(digits = 2)
```


...and by age_group:


CFR by age group among inpatients with known outcomes

```{r cfr_by_age_group, warning = FALSE, message = FALSE}

linelist_cleaned %>%
  filter(patient_facility_type == "Inpatient") %>%
  case_fatality_rate_df(deaths = DIED, group = age_group, mergeCI = TRUE, add_total = TRUE) %>%
  tidyr::complete(age_group, 
                  fill = list(deaths = 0, population = 0, cfr = 0, ci = 0)) %>% # Ensure all levels are represented
  rename("Age Group" = age_group, 
         "Deaths" = deaths, 
         "Cases" = population, 
         "CFR (%)" = cfr, 
         "95%CI" = ci) %>% 
  knitr::kable(digits = 2)
```


CFR by case definition (not enough to do)

```{r cfr_by_case_def, warning = FALSE, message = FALSE}
# Use if you have enough confirmed cases for comparative analysis 
#
 linelist_cleaned %>%
   filter(patient_facility_type == "Inpatient") %>%
   case_fatality_rate_df(deaths = DIED, group = case_def, mergeCI = TRUE, add_total = TRUE) %>%
   rename("Case Definition" = case_def, 
          "Deaths" = deaths, 
          "Cases" = population, 
          "CFR (%)" = cfr, 
          "95%CI" = ci) %>% 
   knitr::kable(digits = 2)
```


## Attack Rate
To use the attack rate section, we need to modify the first code slightly. An object "population" is created from the sum of population counts in the population figures. Because we only imported region-based population counts, we must change this command to reflect that we do not have population_data_age, but rather population_data_region

```{r eval=FALSE}
# OLD define population 
# population <- sum(population_data_age$population)
```

Running the correct command and printing the value of population, we see that the sum population across regions is estimated to be 62336.
```{r}
# Correct command for this exercise
population <- sum(population_data_region$population)

population
```

Below gives the attack rate per 10,000 population (N = `r format(population, big.mark = ",")`)
```{r attack_rate}
# calculate the ar
# store as AR to be able to use output for automating text below (inline functions)
ar <- attack_rate(nrow(linelist_cleaned), population, multiplier = 10000)

ar %>%
  merge_ci_df(e = 3) %>% # merge the lower and upper CI into one column
  rename("Cases (n)" = cases, 
         "Population" = population, 
         "AR (per 100,000)" = ar, 
         "95%CI" = ci) %>% 
  select(-Population) %>% # drop the population column as it is not changing
  knitr::kable(digits = 2, align = "r")
```

We are unable to calculate the attack rate by age group, because we do not have population counts for each age group.

Mortality attributable to AJS - not appropriate for this example because...


```{r, include=FALSE, results='hide', message=FALSE, warning=FALSE}
# Save linelist_cleaned for use in the next page (time analyses).
saveRDS(linelist_cleaned, "data/linelist_person_cleaned.rds")
```


