---
date: "2019-08-21T11:00:29+02:00"
title: Time analyses
weight: 13
---



<p>TODO: Introduction to time analyses…</p>
<div id="classic-epidemic-curve" class="section level3">
<h3>Classic epidemic curve</h3>
<p>The first code chunk (create_incidence) is about setting-up the data for the epidemic curves. <strong>There will not be output from this first code chunk.</strong></p>
<p><strong>First</strong>, the function incidence() <strong>counts the number of cases</strong> for each week, by date_of_onset. It stores this information in the object inc_week_7.</p>
<p><strong>Second</strong>, the <strong>theme elements</strong> are set that ggplot2() will use when plotting the epidemic curves (you can read more about ggplot2 and theme elements HERE TODO). This includes the angle and placement of x-axis label text, having no title in the legend, and setting colors and type for x and y gridlines.</p>
<p><strong>Third</strong>, the <strong>text labels</strong> for the x and y axes, title, and subtitle (subtitle automatically using the reporting week defined at the top of the template). These are stored in the object epicurve_labels.</p>
<p><strong>Note: It is necessary to use the “full name” of variables for this to work correctly - this means date_of_onset should be listed in incidence() as <code>linelist_cleaned$date_of_onset</code>.</strong></p>
<pre class="r"><code># This code creates case counts for each week of your outbreak, overall
# As with aweek, you can change the start of your week to e.g. &quot;Sunday week&quot;
inc_week_7 &lt;- incidence(linelist_cleaned$date_of_onset, interval = &quot;Monday week&quot;)

# this sets the theme in ggplot for epicurves
epicurve_theme &lt;- theme(
  axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
  legend.title = element_blank(),
  panel.grid.major.x = element_line(color = &quot;grey60&quot;, linetype = 3),
  panel.grid.major.y = element_line(color = &quot;grey60&quot;, linetype = 3)
)

# This sets the labels in ggplot for the epicurves
epicurve_labels &lt;- labs(x = &quot;Calendar week&quot;, 
                        y = &quot;Cases (n)&quot;, 
                        title = &quot;Cases by week of onset&quot;,
                        subtitle = sprintf(&quot;Source: MSF data from %s&quot;, reporting_week)
                       ) </code></pre>
<p><strong>In this next chunk (epicurve), the plot of the epidemic curve is finalized and displayed.</strong></p>
<p><em>Note that the plot() function used here is from the package incidence(), not the base R plot() function. This one uses ggplot2() and so has different syntax and structure. As with ggplot2, layers of the graphic are added sequentially using the + symbol at the end of each sub-command.</em></p>
<p>In this case, the data from inc_week_7 are plotted first, then y-axis origin is set, then the labels, and finally the theme parameters. All of these elements are stored in the object “basic_curve”, which is finally run to display the result.</p>
<p><strong>Note: It is necessary to use the “full name” of variables for this to work correctly - this means date_of_onset should be listed in incidence() as <code>linelist_cleaned$date_of_onset</code>.</strong> Otherwise you may get an error such as “object ‘date_of_onset’ not found”.</p>
<pre class="r"><code># plot your epicurve as a ggplot (incidence::plot is different to base::plot)
basic_curve &lt;- plot(inc_week_7, show_cases = TRUE, border = &quot;black&quot;, n_breaks = nrow(inc_week_7)) + 
  scale_y_continuous(expand = c(0, 0)) +  # set origin for axes
  # add labels to axes and below chart
  epicurve_labels +
  # change visuals of dates and remove legend title
  epicurve_theme
# show your plot (stored for later use) 
basic_curve</code></pre>
<p><img src="/training/Walk-through/time_analyses_files/figure-html/epicurve-1.png" width="720" /></p>
<p>The x-axis is visually quite busy with every week displayed. To increase read-ability we can uncomment and use the helper code at the bottom of the code chunk. This code modifies the already-defined basic_curve (with a +) to specify that the x-axis shows only a specified number of breaks/dates (in this case 6).</p>
<p><em>Note that the data are still shown by week - it is only the labels on the scale that have changed.</em></p>
<pre class="r"><code># Modifies basic_curve to show only 6 breaks in the x-axis 
basic_curve + scale_x_incidence(inc_week_7, n_breaks = 6)</code></pre>
<pre><code>## Scale for &#39;x&#39; is already present. Adding another scale for &#39;x&#39;, which
## will replace the existing scale.</code></pre>
<p><img src="/training/Walk-through/time_analyses_files/figure-html/unnamed-chunk-1-1.png" width="720" /> <strong>To change the intervals used for the data aggregation themselves</strong>, use the <code>interval =</code> argument in the original incidence() command. There are the options to do this biweekl, by month, quarter or year (see the Help guidance for the incidence() function in the incidence package. <strong>This is a biweekly example</strong>.</p>
<p><em>Note: In the code below, the plot is not saved to an object and simply prints when the plot() command and it’s various added (+) elements such as scale, labels, and theme are run.</em></p>
<pre class="r"><code># interval is set to &quot;2 Monday weeks&quot; for biweekly case aggregation
inc_week_14 &lt;- incidence(linelist_cleaned$date_of_onset, interval = &quot;2 Monday weeks&quot;)

# plot the epicurve
plot(inc_week_14, show_cases = TRUE, border = &quot;black&quot;, n_breaks = nrow(inc_week_14)) + 
  scale_y_continuous(expand = c(0,0)) +  # set origin for axes
  # add labels to axes and below chart
  epicurve_labels +
  # change visuals of dates and remove legend title
  epicurve_theme</code></pre>
<p><img src="/training/Walk-through/time_analyses_files/figure-html/biweekly_epicurve-1.png" width="720" /></p>
<p>To <strong>stratify the epidemic curve</strong> by a categorical variable (such as gender), the <code>groups =</code> argument is added to the incidence() function. Additionally, the <code>show_cases =</code> argument of plot() is set to FALSE to aid the aesthetics.</p>
<p><strong>Note: Remember that if listing a variable, the plot() function expects its “full name”, such as <code>linelist_cleaned$sex</code></strong>. Otherwise you may get an error such as “object ‘sex’ not found”.</p>
<pre class="r"><code># get counts by gender
inc_week_7_gender &lt;- incidence(linelist_cleaned$date_of_onset, 
                               interval = &quot;2 Monday weeks&quot;, 
                               groups = linelist_cleaned$sex)
# plot your epicurve
# here we remove the boxes around each case as it makes gender colours hard to see! (show_cases = FALSE)
plot(inc_week_7_gender, show_cases = FALSE, border = &quot;black&quot;, n_breaks = nrow(inc_week_7_gender)) + 
  scale_y_continuous(expand = c(0,0)) +  # set origin for axes
  # add labels to axes and below chart
  epicurve_labels +
  # change visuals of dates, remove legend title and move legend to bottom
  epicurve_theme</code></pre>
<p><img src="/training/Walk-through/time_analyses_files/figure-html/incidence_by_gender-1.png" width="720" /></p>
<p>Lastly, we can limit the entire plot to a subset of observations by first filtering the dataset and passing the result to the incidence() function.</p>
<p>The example below creates the object inc_week_7_sex_fac, as defined as the result of incidence() operating upon a filtered version of linelist_cleaned. The filter used means only Inpatient observations are included. Note how fewer cases there are.</p>
<pre class="r"><code># filter the dataset and pass it to the incidence() function
inc_week_7_sex_fac &lt;- linelist_cleaned %&gt;%
  filter(patient_facility_type == &quot;Inpatient&quot;) %&gt;%
  with(incidence(date_of_onset, interval = &quot;2 Monday weeks&quot;, groups = sex))

# plot as before
plot(inc_week_7_sex_fac, show_cases = TRUE, border = &quot;black&quot;, n_breaks = nrow(inc_week_7_sex_fac)) + 
  scale_y_continuous(expand = c(0, 0)) +  # set origin for axes
  # add labels to axes and below chart
  epicurve_labels +
  # change visuals of dates, remove legend title and move legend to bottom
  epicurve_theme</code></pre>
<p><img src="/training/Walk-through/time_analyses_files/figure-html/incidence_by_sex_facility-1.png" width="720" /></p>
</div>
<div id="plotting-other-indicators-by-time" class="section level3">
<h3>Plotting other indicators by time</h3>
<div id="attack-rate-by-week" class="section level4">
<h4>Attack rate by week</h4>
<p>The code below</p>
<pre class="r"><code># counts and cumulative counts by week
cases &lt;- linelist_cleaned %&gt;%
  arrange(date_of_onset) %&gt;%        # arrange by date of onset
  count(epiweek, .drop = FALSE) %&gt;% # count all epiweeks and include zero counts
  mutate(cumulative = cumsum(n))    # add a cumulative sum

# attack rate for each week
ar &lt;- attack_rate(cases$n, population, multiplier = 100000) %&gt;% 
  bind_cols(select(cases, epiweek), .) # add the epiweek column to table</code></pre>
<pre><code>## Error in proportion(cases, population, multiplier = multiplier, conf_level = conf_level): object &#39;population&#39; not found</code></pre>
<pre class="r"><code>ar %&gt;%
  merge_ci_df(e = 4) %&gt;% # merge the lower and upper CI into one column
  rename(&quot;Epiweek&quot; = epiweek, 
         &quot;Cases (n)&quot; = cases, 
         &quot;Population&quot; = population, 
         &quot;AR (per 100,000)&quot; = ar, 
         &quot;95%CI&quot; = ci) %&gt;% 
  knitr::kable(digits = 2, align = &quot;r&quot;)</code></pre>
<pre><code>## Error in x[[e]]: object of type &#39;closure&#39; is not subsettable</code></pre>
<p>And cumulatively:</p>
<pre class="r"><code># cumulative attack rate by week
attack_rate(cases$cumulative, population, multiplier = 100000) %&gt;% 
  bind_cols(select(cases, epiweek), .) %&gt;% # add the epiweek column to table
  merge_ci_df(e = 4) %&gt;% # merge the lower and upper CI into one column
  rename(&quot;Epiweek&quot; = epiweek, 
         &quot;Cases (n)&quot; = cases, 
         &quot;Population&quot; = population, 
         &quot;AR (per 100,000)&quot; = ar, 
         &quot;95%CI&quot; = ci) %&gt;% 
  knitr::kable(digits = 2, align = &quot;r&quot;)</code></pre>
<pre><code>## Error in proportion(cases, population, multiplier = multiplier, conf_level = conf_level): object &#39;population&#39; not found</code></pre>
<pre class="r"><code># group by known outcome and case definition 
cfr &lt;- linelist_cleaned %&gt;%
  filter(patient_facility_type == &quot;Inpatient&quot;) %&gt;%
  case_fatality_rate_df(grepl(&quot;Dead&quot;, exit_status), group = epiweek)

cfr %&gt;%
  merge_ci_df(e = 4) %&gt;% # merge the lower and upper CI into one column
  rename(&quot;Epiweek&quot; = epiweek, 
         &quot;Deaths&quot; = deaths, 
         &quot;Cases&quot; = population, 
         &quot;CFR (%)&quot; = cfr, 
         &quot;95%CI&quot; = ci) %&gt;% 
  knitr::kable(digits = 2, align = &quot;r&quot;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">Epiweek</th>
<th align="right">Deaths</th>
<th align="right">Cases</th>
<th align="right">CFR (%)</th>
<th align="right">95%CI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2016-W30</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2016-W33</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="odd">
<td align="right">2016-W37</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">(0.00–48.99)</td>
</tr>
<tr class="even">
<td align="right">2016-W38</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">(0.00–56.15)</td>
</tr>
<tr class="odd">
<td align="right">2016-W39</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">(0.00–65.76)</td>
</tr>
<tr class="even">
<td align="right">2016-W40</td>
<td align="right">0</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">(0.00–43.45)</td>
</tr>
<tr class="odd">
<td align="right">2016-W41</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2016-W42</td>
<td align="right">0</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">(0.00–43.45)</td>
</tr>
<tr class="odd">
<td align="right">2016-W43</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2016-W44</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="odd">
<td align="right">2016-W45</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">(0.00–56.15)</td>
</tr>
<tr class="even">
<td align="right">2016-W46</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">(0.00–48.99)</td>
</tr>
<tr class="odd">
<td align="right">2016-W47</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2016-W48</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="odd">
<td align="right">2016-W50</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2016-W51</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="odd">
<td align="right">2016-W52</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">(0.00–65.76)</td>
</tr>
<tr class="even">
<td align="right">2017-W01</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">(0.00–65.76)</td>
</tr>
<tr class="odd">
<td align="right">2017-W02</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2017-W03</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">(0.00–65.76)</td>
</tr>
<tr class="odd">
<td align="right">2017-W04</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">(0.00–48.99)</td>
</tr>
<tr class="even">
<td align="right">2017-W05</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="odd">
<td align="right">2017-W06</td>
<td align="right">0</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">(0.00–43.45)</td>
</tr>
<tr class="even">
<td align="right">2017-W07</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="odd">
<td align="right">2017-W08</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2017-W09</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="odd">
<td align="right">2017-W10</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">2017-W13</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">(0.00–65.76)</td>
</tr>
<tr class="odd">
<td align="right">2017-W14</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">(0.00–79.35)</td>
</tr>
<tr class="even">
<td align="right">-</td>
<td align="right">0</td>
<td align="right">27</td>
<td align="right">0</td>
<td align="right">(0.00–12.46)</td>
</tr>
</tbody>
</table>
<p>You could plot the AR (in the population) and CFR (among inpatients only) together as line graphs by epiweek.</p>
<pre class="r"><code>ar_plot &lt;- ggplot(ar, aes(x = week2date(epiweek) + (7 * 0.5), group = 1)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), 
              color = &quot;blue&quot;, fill = &quot;blue&quot;, linetype = 2, alpha = 0.2, show.legend = FALSE) +
  geom_line(aes(y = ar), color = &quot;blue&quot;, show.legend = FALSE) +
  scale_y_continuous(expand = c(0, 0)) +  # set origin for axes
  # scale the x axis the same as the incidence curve. Expand forces it to align. 
  incidence::scale_x_incidence(inc_week_7, n_breaks = nrow(inc_week_7), expand = c(0, 7 * 1.5)) +
  # add labels to axes and below chart
  labs(x = &quot;Calendar week&quot;, y = &quot;AR [95% CI]&quot;, subtitle = &quot;Attack Rate (per 100,000)&quot;) + 
  # change visuals of dates and remove legend title
  epicurve_theme</code></pre>
<pre><code>## Error: You&#39;re passing a function as global data.
## Have you misspelled the `data` argument in `ggplot()`</code></pre>
<p>To plot CFR you must first make the CFR table using above code</p>
<pre class="r"><code>cfr_plot &lt;- ggplot(cfr, aes(x = week2date(epiweek) + (7 * 0.5), group = 1)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), 
              color = &quot;red&quot;, fill = &quot;red&quot;, linetype = 2, alpha = 0.2, show.legend = FALSE) +
  geom_line(aes(y = cfr), color = &quot;red&quot;, show.legend = FALSE) +
  scale_y_continuous(expand = c(0, 0)) +  # set origin for axes
  # scale the x axis the same as the incidence curve. Expand forces it to align. 
  incidence::scale_x_incidence(inc_week_7, n_breaks = nrow(inc_week_7), expand = c(0, 7 * 1.5)) +
  # add labels to axes and below chart
  labs(x = &quot;Calendar week&quot;, y = &quot;CFR [95% CI]&quot;, 
       subtitle = &quot;Case Fatality Ratio [95% CI] Among Inpatients&quot;) + 
  # change visuals of dates and remove legend title
  epicurve_theme </code></pre>
<p>You could then also add the AR and CFR by week on to an epicurve.</p>
<pre class="r"><code>nofx &lt;- theme(axis.text.x = element_blank(),
              axis.title.x = element_blank())
cowplot::plot_grid(
  basic_curve + nofx,
  ar_plot + nofx,
  cfr_plot,
  align = &quot;v&quot;, # align plots vertically
  axis = &quot;lr&quot;, # only by their left and right margins
  ncol = 1     # allow only one column
)</code></pre>
<pre><code>## Error in cowplot::plot_grid(basic_curve + nofx, ar_plot + nofx, cfr_plot, : object &#39;ar_plot&#39; not found</code></pre>
<p>more optins…</p>
</div>
</div>
