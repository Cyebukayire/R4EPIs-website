---
date: "2019-08-22T15:33:00+02:00"
title: Advanced and Miscellaneous
weight: 13
---



```{r include=FALSE, results='hide', message=FALSE, warning=FALSE}
# Silently read AJS example dataset

library(sitrep)
library(here)
library(dplyr)
library(forcats)

linelist_cleaned <- gen_data("AJS")

```


### Factors and the forcats() package  

#### Factors

Factors are a special variable class in which data are stored internally as integers, but each integer *level* has a corresponding character value *label* that is used when the data are displayed. This can be partularly helpful when running statistical models which expect numeric (e.g. 0/1) inputs.  

*Factors are similar to labeled values of categorical variables in Stata.*  

You can read more about factors [here](https://www.stat.berkeley.edu/~s133/factors.html).  

The package forcats provides useful tools for working with factor variables. You can read more about forcats [here](https://www.rdocumentation.org/packages/forcats/versions/0.4.0).  

> For example, in the automatically generated AJS dataset, the variable `sex` is a factor. In the underlying dataset the levels are F, M, and U, but we can attach longer character labels that are displayed.  

```{r}
# Use auto-generated dataset for this example
linelist_cleaned <- gen_data("AJS")

# the variable is a factor. 
class(linelist_cleaned$sex)
```
*Note: To convert use as.factor() `linelist_cleaned$sex <- as.factor(linelist_cleaned$sex)`*  

**To change the labels for a variable, use the function fct_recode() from the package forcats.**  

After providing the name of the factor give the conversion statements, separated by commas, in the format **NEW = "OLD"**. Note that everything on the right-hand side (RHS) must be a character. So, if you want to give a new label to missing values, use the special term `NA_character_`.  

First we use fct_count() from the package forcats to see the values in the factor:

```{r}
# View the levels present in the variable
fct_count(linelist_cleaned$sex)
```

Now we re-label the values using fct_recode(), also from the package forcats.  

```{r}
# Re-define the labels for the factor variable (pay attention to spelling!)
linelist_cleaned$sex <- fct_recode(linelist_cleaned$sex, 
                                   Male = "M",
                                   Female = "F",
                                   Unknown = "U")

# View the levels present in the variable
fct_count(linelist_cleaned$sex)
```

**To change the *order* of the levels, use fct_relevel()**.  

This will impact the *order* of the levels as displayed in graphs and tables. Give the name of the factor followed by the new order (pay attention to spelling!).  


```{r}
# Provide new order of levels
linelist_cleaned$sex <- fct_relevel(linelist_cleaned$sex, "Female", "Male", "Unknown")

# Check order of levels
levels(linelist_cleaned$sex)
```


#### Dropping factor levels  

If a variable is already a factor, it can be difficult to remove levels that do not have any observations. These levels will continue to appear in graphs, tables, etc.  

> For example, here we look at the values present in the variable sex. We want to convert those that are "U" to proper R missing values (`NA`).

```{r}
# Convert "U" values to missing
linelist_cleaned$sex[linelist_cleaned$sex == "U"] <- NA

# see the values and counts in the factor variable sex
fct_count(linelist_cleaned$sex)
```

> We can see that the value "U" now has a count of zero, but it is still present as a level of the factor variable and will appear in tables and graphs. To remove this level entirely we use fct_drop(), which drops unused levels from a factor.

```{r}
# Drop unused levels
linelist_cleaned$sex <- fct_drop(linelist_cleaned$sex)

# see the values and counts in the factor variable sex
fct_count(linelist_cleaned$sex)
``` 

*Note: Use the argument `only = ` to drop specific levels: `fct_drop(linelist_cleaned$sex, only = "U")`*


### The %in% operator  

The operator %in% looks to see if a value is present within a vector. A vector can be created with the function c(), and a variable in a data frame is also a vector. 

In the simple example below, R is asked if the number 4 is present in the vector "numbers":

```{r}
# Vector is defined
numbers <- c(4, 10, 5, 365, 12, 0.5, 9)

# Test if 5 is in the vector
5 %in% numbers
```

In the templates, %in% can be used when creating the valued "DIED" (when a patient died). The variable DIED is logical (either TRUE or FALSE). It will be TRUE if the value in exit_status is either "DD" or "DOA" - those are the two character values present in the vector. You can add to or change the terms listed in the vector.

```{r eval=FALSE}
#DIED == TRUE if value in exit_status is "DD" or "DOA"
linelist_cleaned$DIED <- linelist_cleaned$exit_status %in% c("DD", "DOA"))
```

You can read more abouth %in% [here](http://www.datasciencemadesimple.com/in-operator-in-r/)


## Joins  

The package dplyr contains functions that are used in the templates for joining ("merging") data frames. 
There are many options for joins, and it is important that you use the correct one - otherwise you risk losing data unexpectedly.

It is wise to verify any join by inspecting the joined data frames and the resulting data frame. 

There are more reference materials on dyplr join functions [here](https://stat545.com/bit001_dplyr-cheatsheet.html) and [here](https://rpubs.com/williamsurles/293454), and the animations below can be acccessed [here](https://github.com/gadenbuie/tidyexplain).

### Left join  

An example of a left join from the AJS outbreak template occurs in the TODO

![](/images/left-join.gif)


![](/images/right-join.gif)

![](/images/full-join.gif)

![](/images/inner-join.gif)


